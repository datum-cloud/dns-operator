data_dir: /var/lib/vector

api:
  enabled: false

sources:
  dnstap_tcp:
    type: socket
    address: 0.0.0.0:6001
    mode: tcp
    decoding:
      codec: json
  internal_metrics:
    type: internal_metrics

transforms:
  dnstap_enriched:
    type: remap
    inputs:
      - dnstap_tcp
    source: |
      # Reuse dns-collector enrichment; only normalize for metrics
      .message_type = upcase(to_string(.dnstap.operation) ?? "UNKNOWN")
      .server_id = to_string(.dnstap.identity) ?? "unknown"
      .stream_id = .server_id
      .proto = to_string(.network.protocol) ?? "unknown"
      .family = to_string(.network.family) ?? "unknown"
      .opcode = to_string(.dns.opcode) ?? "unknown"
      .qname = downcase(to_string(.dns.qname) ?? "unknown")
      .qtype = to_string(.dns.qtype) ?? "unknown"
      .rcode = upcase(to_string(.dns.rcode) ?? "UNKNOWN")
      .zone = downcase(to_string(.publicsuffix."etld+1") ?? .qname)
      .hit = 1

      if exists(.dnstap.latency) {
        lat, err = to_float(.dnstap.latency)
        if err == null {
          .latency_seconds = lat
        }
      }

      # Cache heuristic: dnsdist identity naming (e.g., *_cache)
      .cache_hit = contains(.server_id, "_cache")

      # DNSSEC status via AD bit and SERVFAIL heuristic
      ad = to_bool(.dns.flags.ad) ?? false
      status = "insecure"
      if ad { status = "secure" }
      if .rcode == "SERVFAIL" { status = "bogus" }
      .dnssec_status = status

  dnstap_metrics:
    type: log_to_metric
    inputs:
      - dnstap_enriched
    metrics:
      - type: counter
        name: dns_queries_total
        field: hit
        condition: '.message_type == "CLIENT_QUERY"'
        tags:
          family: "{{family}}"
          proto: "{{proto}}"
          opcode: "{{opcode}}"
          qtype: "{{qtype}}"
          zone: "{{zone}}"
          server: "{{server_id}}"
          stream: "{{stream_id}}"
      - type: counter
        name: dns_responses_total
        field: hit
        condition: '.message_type == "CLIENT_RESPONSE"'
        tags:
          family: "{{family}}"
          proto: "{{proto}}"
          qtype: "{{qtype}}"
          rcode: "{{rcode}}"
          server: "{{server_id}}"
          zone: "{{zone}}"
          stream: "{{stream_id}}"
      - type: counter
        name: dns_cache_hits_total
        field: hit
        condition: '.message_type == "CLIENT_RESPONSE" && .cache_hit == true'
        tags:
          proto: "{{proto}}"
          server: "{{server_id}}"
          zone: "{{zone}}"
          qtype: "{{qtype}}"
      - type: counter
        name: dns_dnssec_status_total
        field: hit
        condition: '.message_type == "CLIENT_RESPONSE"'
        tags:
          proto: "{{proto}}"
          server: "{{server_id}}"
          zone: "{{zone}}"
          dnssec_status: "{{dnssec_status}}"
      - type: counter
        name: dns_servfail_total
        field: hit
        condition: '.message_type == "CLIENT_RESPONSE" && .rcode == "SERVFAIL"'
        tags:
          proto: "{{proto}}"
          server: "{{server_id}}"
          zone: "{{zone}}"
          qtype: "{{qtype}}"
      - type: counter
        name: dns_nxdomain_total
        field: hit
        condition: '.message_type == "CLIENT_RESPONSE" && .rcode == "NXDOMAIN"'
        tags:
          proto: "{{proto}}"
          server: "{{server_id}}"
          zone: "{{zone}}"
          qtype: "{{qtype}}"
      - type: histogram
        name: dns_response_latency_seconds
        field: latency_seconds
        condition: '.message_type == "CLIENT_RESPONSE" && exists(.latency_seconds)'
        bins: [0.0001, 0.0005, 0.001, 0.005, 0.01, 0.05, 0.1, 0.25, 0.5, 1, 2, 5]
        tags:
          proto: "{{proto}}"
          qtype: "{{qtype}}"
          rcode: "{{rcode}}"
          server: "{{server_id}}"
          zone: "{{zone}}"

sinks:
  console:
    type: console
    target: stdout
    encoding:
      codec: json
    inputs:
      - dnstap_tcp

  prometheus:
    type: prometheus_exporter
    inputs:
      - dnstap_metrics
      - internal_metrics
    address: 0.0.0.0:9598

  loki:
    type: loki
    inputs:
      - dnstap_tcp
    endpoint: http://loki.dns-monitoring.svc:3100
    out_of_order_action: accept
    encoding:
      codec: json
    labels:
      job: vector
      app: vector
      component: vector
      server: "{{server_id}}"
      proto: "{{proto}}"
      family: "{{family}}"
      message_type: "{{message_type}}"
