apiVersion: apps/v1
kind: Deployment
metadata:
  name: pdns-auth
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pdns-auth
  template:
    metadata:
      labels:
        app: pdns-auth
    spec:
      initContainers:
      - name: init-pdns-key
        image: busybox:1.36
        command: ["/bin/sh","-c"]
        args:
        - 'set -eu; mkdir -p /run/pdns; umask 077; KEY=$(head -c32 /dev/urandom | od -An -tx1 | tr -d " \n"); echo -n "$KEY" > /run/pdns/api-key; chown -R 65532:65532 /run/pdns; chmod 0400 /run/pdns/api-key;'
        volumeMounts:
        - name: pdns-shared
          mountPath: /run/pdns
        securityContext:
          runAsNonRoot: false
          runAsUser: 0
      containers:
      - name: pdns
        image: powerdns/pdns-auth-51:latest
        env:
        - name: PDNS_AUTH_API_KEY
          value: ""
        - name: DEBUG_CONFIG
          value: "yes"
        ports:
        - containerPort: 53
          name: dns
          protocol: UDP
        - containerPort: 53
          name: dns-tcp
          protocol: TCP
        - containerPort: 8081
          name: api
          protocol: TCP
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          capabilities:
            add: ["NET_BIND_SERVICE"]
        volumeMounts:
        - name: pdns-shared
          mountPath: /run/pdns
        command: ["/bin/sh","-c"]
        args:
        - |
          set -eu;
          exec pdns_server \
            --disable-syslog=yes \
            --daemon=no \
            --api=yes \
            --api-key="$(cat /run/pdns/api-key)" \
            --webserver=yes \
            --webserver-address=0.0.0.0 \
            --webserver-allow-from=0.0.0.0/0 \
            --webserver-port=8081 \
            --server-id=localhost
      volumes:
      - name: pdns-shared
        emptyDir: {}

