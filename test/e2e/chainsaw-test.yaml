# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/chainsaw/main/.schemas/json/test-chainsaw-v1alpha1.json
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: dns-operator-end-to-end
spec:
  clusters:
    upstream:
      kubeconfig: kubeconfig-upstream
    downstream:
      kubeconfig: kubeconfig-downstream
  cluster: upstream
  steps:
  - name: Prereq - create DNSZoneClass in upstream
    try:
    - create:
        cluster: upstream
        resource:
          apiVersion: dns.networking.miloapis.com/v1alpha1
          kind: DNSZoneClass
          metadata:
            name: powerdns-static
          spec:
            controllerName: powerdns
            nameServerPolicy:
              mode: Static
              static:
                servers:
                - ns1.example.com
                - ns2.example.com
            defaults:
              defaultTTL: 300
    - assert:
        cluster: upstream
        resource:
          apiVersion: dns.networking.miloapis.com/v1alpha1
          kind: DNSZoneClass
          metadata:
            name: powerdns-static

  - name: Prereq - create DNSZoneClass in downstream
    try:
    - create:
        cluster: downstream
        resource:
          apiVersion: dns.networking.miloapis.com/v1alpha1
          kind: DNSZoneClass
          metadata:
            name: powerdns-static
          spec:
            controllerName: powerdns
            nameServerPolicy:
              mode: Static
              static:
                servers:
                - ns1.example.com
                - ns2.example.com
            defaults:
              defaultTTL: 300
    - assert:
        cluster: downstream
        resource:
          apiVersion: dns.networking.miloapis.com/v1alpha1
          kind: DNSZoneClass
          metadata:
            name: powerdns-static

  - name: Create DNSZone upstream
    try:
    - create:
        cluster: upstream
        resource:
          apiVersion: dns.networking.miloapis.com/v1alpha1
          kind: DNSZone
          metadata:
            name: example-com
          spec:
            domainName: example.com
            dnsZoneClassName: powerdns-static
    - assert:
        cluster: upstream
        resource:
          apiVersion: dns.networking.miloapis.com/v1alpha1
          kind: DNSZone
          metadata:
            name: example-com

  - name: Confirm DNSZone replicated downstream
    try:
    - script:
        cluster: upstream
        skipCommandOutput: true
        skipLogOutput: true
        content: |
          kubectl get ns $NAMESPACE -o json
        outputs:
        - name: downstreamNamespaceName
          value: (join('-', ['ns', json_parse($stdout).metadata.uid]))
    - assert:
        cluster: downstream
        resource:
          apiVersion: dns.networking.miloapis.com/v1alpha1
          kind: DNSZone
          metadata:
            name: example-com
            namespace: ($downstreamNamespaceName)

  - name: Confirm DNSZone Accepted/Programmed upstream
    try:
    - assert:
        cluster: upstream
        resource:
          apiVersion: dns.networking.miloapis.com/v1alpha1
          kind: DNSZone
          metadata:
            name: example-com
          status:
            conditions:
            - type: Accepted
              status: "True"
            - type: Programmed
              status: "True"

  - name: Assert upstream DNSZone nameservers
    try:
    - assert:
        cluster: upstream
        resource:
          apiVersion: dns.networking.miloapis.com/v1alpha1
          kind: DNSZone
          metadata:
            name: example-com
          status:
            nameservers:
            - ns1.example.com
            - ns2.example.com

  - name: Create DNSRecordSet upstream
    try:
    - create:
        cluster: upstream
        resource:
          apiVersion: dns.networking.miloapis.com/v1alpha1
          kind: DNSRecordSet
          metadata:
            name: www-example-com
          spec:
            dnsZoneRef:
              name: example-com
            recordType: A
            records:
            - name: www
              ttl: 300
              a:
                content:
                - 10.0.0.1
    - assert:
        cluster: upstream
        resource:
          apiVersion: dns.networking.miloapis.com/v1alpha1
          kind: DNSRecordSet
          metadata:
            name: www-example-com

  - name: Confirm DNSRecordSet replicated downstream
    try:
    - script:
        cluster: upstream
        skipCommandOutput: true
        skipLogOutput: true
        content: |
          kubectl get ns $NAMESPACE -o json
        outputs:
        - name: downstreamNamespaceName
          value: (join('-', ['ns', json_parse($stdout).metadata.uid]))
    - assert:
        cluster: downstream
        resource:
          apiVersion: dns.networking.miloapis.com/v1alpha1
          kind: DNSRecordSet
          metadata:
            name: www-example-com
            namespace: ($downstreamNamespaceName)

  - name: Confirm DNSRecordSet Accepted/Programmed upstream
    try:
    - assert:
        cluster: upstream
        resource:
          apiVersion: dns.networking.miloapis.com/v1alpha1
          kind: DNSRecordSet
          metadata:
            name: www-example-com
          status:
            conditions:
            - type: Accepted
              status: "True"
            - type: Programmed
              status: "True"


